%
% This document contains the chapter about harmonic balance analysis.
%
% Copyright (C) 2005 Stefan Jahn <stefan@lkcc.org>
% Copyright (C) 2005 Michael Margraf <Michael.Margraf@alumni.TU-Berlin.DE>
%
% Permission is granted to copy, distribute and/or modify this document
% under the terms of the GNU Free Documentation License, Version 1.1
% or any later version published by the Free Software Foundation.
%

\chapter{Harmonic Balance Analysis}
\label{sec:hb_analysis}

Harmonic balance is a non-linear, frequency-domain, steady-state
simulation.  The voltage and current sources create discrete
frequencies resulting in a spectrum of discrete frequencies at every
node in the circuit. Linear circuit components are solely modeled in
frequency domain. Non-linear components are modeled in time domain and
Fourier-transformed before each solving step.  The informations in
this chapter are taken from \cite{Maas1} (chapter 3) which is a very
nice and well-written publication on this topic.

\addvspace{12pt}

The harmonic balance simulation is ideal for situations where
transient simulation methods are problematic. These are:
\begin{itemize}
\item components modeled in frequency domain, for instance (dispersive)
      transmission lines
\item circuit time constants large compared to period of simulation
      frequency
\item circuits with lots of reactive components
\end{itemize}
Harmonic balance methods, therefore, are the best choice for most microwave
circuits excited with sinusoidal signals (e.g. mixers, power amplifiers).


\section{The Basic Concept}

As non-linear elements can only be modeled in time domain, the circuit
first must be separated into a linear and a non-linear part. The
internal impedances $Z_i$ of the voltage sources are put into the
linear part as well. Figure \ref{fig:hb_concept} illustrates the
concept. Let us define the following symbols:
\begin{description}
\item[] M = number of (independent) voltage sources
\item[] N = number of connections between linear and non-linear subcircuit
\item[] K = number of calculated harmonics
\end{description}

\begin{figure}[ht]
\begin{center}
\includegraphics[width=9cm]{hb_concept}
\end{center}
\caption{circuit partitioning in harmonic balance}
\label{fig:hb_concept}
\end{figure}
\FloatBarrier

The linear circuit is modeled by two transadmittance matrices:
The first one $(\tilde{\underline{Y}})$
relates the source voltages $v_{S,1}...v_{S,M}$ to the interconnection
currents $i_1...i_N$ and the second one $(\hat{\underline{Y}})$
relates the interconnection
voltages $v_1...v_N$ to the interconnection currents $i_1...i_N$.
Taking both, we can express the current flowing through the
interconnections between linear and non-linear subcircuit:

\begin{equation}
\label{eqn:HBlin}
(\underline{I})
  = (\underline{\tilde{Y}})\cdot (\underline{V}_S) + (\underline{\hat{Y}})\cdot (\underline{V})
  = (\underline{I}_S) + (\underline{\hat{Y}})\cdot (\underline{V})
\end{equation}
Because $(\underline{V}_S)$ is known and constant, the first term
can already be computed to give $(\underline{I}_S)$.

\addvspace{12pt}

The non-linear circuit is modeled by its current function
$i(t) = f_g(v_1, ..., v_N)$
and by the charge of its capacitances
$q(t) = f_q(v_1, ..., v_N)$.
These functions must be Fourier-transformed to give the
frequency-domain vectors $(\underline{Q})$ and $(\underline{I}_G)$,
respectively.

\addvspace{12pt}

A simulation result is found if the currents through the
interconnections are the same for the linear and the non-linear
subcircuit. This principle actually gave the harmonic balance
simulation its name, because through the interconnections the
currents of the linear and non-linear subcircuits have to be
\textit{balanced} at every \textit{harmonic} frequency. (To
be precise the described method is called KCL-HB, Kirchhoff's
current law harmonic balance.) So, the non-linear equation
system that needs to be solved writes:
\begin{equation}
(\underline{0})
  = \underbrace{(\underline{I}_S) + (\underline{\hat{Y}})\cdot (\underline{V})}_{\text{linear}}
  + \underbrace{j\cdot (\underline{\Omega})\cdot (\underline{Q}) + (\underline{I}_G)}_{\text{non-linear}}
\end{equation}
where matrix $(\underline{\Omega})$ contains the angular frequencies
on the first main diagonal and zeros anywhere else, $(\underline{0})$
is zero matrix.

\addvspace{12pt}

After each iteration step, the inverse Fourier transformation must
be applied to the voltage vector $(\underline{V})$. Then the time domain
voltages $v_1...v_N$ are put into $i(t) = f_g(v_1, ..., v_N)$
and $q(t) = f_q(v_1, ..., v_N)$ again. Now, a Fourier transformation
gives the vectors $(\underline{Q})$ and $(\underline{I}_G)$ for the
next iteration step. After repeating this several times, a simulation
result has hopefully be found.

\section{Going through each Step}

\subsection{Creating Transadmittance Matrix}

It needs several steps to get the transadmittance matrices $[\tilde{Y}]$
and $[\hat{Y}]$ mentioned in equation \eqref{eqn:HBlin}. First the MNA
matrix of the linear subcircuit (figure \ref{fig:hb_concept}) is created
(chapter \ref{sec:MNA}). Then the transimpedance matrix is derived by
exciting one by one the port nodes of the MNA matrix with unity current.
After that the transadmittance matrix is calculated by inverting the
transimpedance matrix. Finally the matrices $[\tilde{Y}]$ and $[\hat{Y}]$
are filled with the corresponding elements of the overall transadmittance
matrix.

\addvspace{12pt}

Now this should be described in more detail: By use of the MNA matrix
$[A]$, the $n$-th column of the transimpedance matrix $[Z]$ should be
calculated. The voltage source at port $n$ is connected to node $i$
(positive terminal) and to port $j$ (negative terminal). This results
in the following equation:
\begin{equation}
\label{eqn:HBtrans}
[A]\cdot
\begin{bmatrix}
V_1\\
\vdots\\
V_K\\
\end{bmatrix}
=
\begin{bmatrix}
0\\
\vdots\\
1\\
\vdots\\
-1\\
\vdots\\
0\\
\end{bmatrix}
\begin{matrix}
 \\
 \\
\leftarrow i\text{-th row}\\
 \\
\leftarrow j\text{-th row}\\
 \\
 \\
\end{matrix}
\end{equation}
After having solved it, $Z_{1,n}$...$Z_{N+M,n}$ are obtained
simply by subtraction of the node voltages:
\begin{equation}
Z_{m,n} = V_k - V_l
\end{equation}
Here the voltage source at port $m$ is connected to node $k$
(positive terminal) and to node $l$ (negative terminal).

\addvspace{12pt}

The next column of $[Z]$ is obtained by changing the right-hand
side of equation \eqref{eqn:HBtrans} appropriately. As this has to
be done $N+M$ times, it is strongly recommended to use LU
decomposition.

\addvspace{12pt}

One further thing must be mentioned: Because the non-linear
components are missing in the linear MNA matrix, there are often
components that are completely disconnected from the rest of the
circuit. The resulting MNA matrix cannot be solved. To avoid
this problem, shunt each port with a $100\Omega$ resistor. The
effect of these resistors can be easily removed by subtracting
0.01S from the first main diagonal of the transadmittance matrix.


\subsection{Termination Criteria}

Frequency components with very different magnitude appear in harmonic
balance simulation. In order to detect when the solver has found an
accurate solution, an absolute as well as relative criteria must be
used on all nodes and at all frequencies. The analysis is regarded as
finished if one of the criteria is satisfied.

\addvspace{12pt}

The absolute and relative criteria write as follows:
\begin{equation}
\left| \tilde{I}_{n,k} + \hat{I}_{n,k} \right| < \epsilon_{abs}
  \qquad \text{for all} \quad n, k
\end{equation}
\begin{equation}
2\cdot \left| \frac{\tilde{I}_{n,k} + \hat{I}_{n,k}}
                   {\tilde{I}_{n,k} - \hat{I}_{n,k}} \right|
  < \epsilon_{rel}  \qquad \text{for all} \quad n, k
\end{equation}
where $\tilde{I}_{n,k}$ is the current of the linear circuit
partition for node $n$ and frequency $k$ and $\hat{I}_{n,k}$
is the current of the non-linear circuit partition.

\subsection{Frequency-Time Domain Transformation}

During every iteration step, the time domain values have to be transformed
into frequency domain and afterwards back again. A standard Fourier
Transformation is not
useful, because with multi-tone excitation many mixing products appear.
The best way to cope with this problem is to use two-dimensional
Fast-Fourier-Transformation (2D-FFT).
